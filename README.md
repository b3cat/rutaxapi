# RuTaxAPI

Библиотека для получения информации о чеках через API Налоговой

## Requirements

На данный момент не представляется возможным в автоматиечском режиме получить токены, необходимые для выполения запросов, поэтом нужо указывать их в файле конфигурации, формат данных можно посмотреть в файле `config.example.toml`, все 3 параметра обязательны

### Как получить необходимые токены

> инструкция для iOS вместе с OSX, которые находятся в одной сети Wi-Fi

Нужно устройство с установленным приложением Проверка чека

На Mac устанавливаем `mitmproxy`

```
brew install mitmproxy
```

Запускаем прокси с веб-интерфейсом, браузер должен открыться автоматически, если нет, то переходим сами на `http://localhost:8081`

```
mitmweb
```

На мобильном устройстве нужно установить проксирование 

1. Настройки
2. Wi-Fi 
3. Ваша сеть (тапнуть по `i`) 
4. Настройка прокси
5. Вручную
6. Вводим IP-адресс и 8080 порт 

В Safari на мобильном устройстве переходим на `mitm.it`, если все ок, то появится кнопки для скачивания сертификатов, скачиваем и устанавливаем, следуя  инструкциям

Сделать сертификат доверенным для расшифровки HTTPS-трафика
1. Настройки
2. Основные 
3. Об этом устройстве
4. Доверие сертификатам
5. Включить сертифкат `mitmproxy`

Переходим в приложение Проверка чека, входим в учетеную запись, нужно будет пройти капчу и получить СМС-сообщение с кодом, после успешного входа в веб-интерфейсе `mitmproxy` должны появиться множество запросов, нам нужен лишь один из них
`POST https://irkkt-mobile.nalog.ru:8888/v2/auth/phone/verify`

Из него мы получаем всю необходимую нам информацию:
![client-secret](https://user-images.githubusercontent.com/32524036/93886921-751e4700-fcff-11ea-8b30-9164bb967a1f.png)
![refresh-token-and-session-id](https://user-images.githubusercontent.com/32524036/93886945-7c455500-fcff-11ea-9050-6213dc57527b.png)

В дальнейшем клиент сможет сам обновлять сессии и токены автоматиечски, руками это делать не нужно 



